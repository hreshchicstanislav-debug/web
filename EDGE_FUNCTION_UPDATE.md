# Обновление Edge Function fetch-asana-stats

## Обзор изменений

Edge Function `fetch-asana-stats` была полностью переписана для поддержки новой бизнес-логики вкладки "Задачи".

## Основные изменения

### 1. Использование поля Q вместо старого "Кол-во товаров"
- Edge Function теперь ищет кастомное поле **Q** (числовое поле) в `custom_fields` задачи
- Старое поле "Кол-во товаров" (GID `1210420107320602`) больше не используется в расчётах
- Старое поле сохраняется в `asana_tasks.quantity` только для обратной совместимости

### 2. Чтение новых кастомных полей Asana
Edge Function теперь читает следующие кастомные поля:
- **Q** — числовое поле для количества товаров (основной источник)
- **"Товар"** — enum поле: "Принесли" (PRINESLI) или "Взять самому со склада" (WAREHOUSE)
- **"когда сфоткал"** — дата съёмки (date поле)
- **"когда обработал"** — дата обработки (date поле)

**Важно:** Если поле "когда обработал" пустое, но задача завершена (`completed = true`), используется `completed_at` как дата обработки.

### 3. Критерий "Сделано"
Задача считается полностью "Сделано", если выполнены **все** условия:
- `Q > 0` (количество товаров заполнено)
- Поле "когда сфоткал" заполнено
- Поле "когда обработал" известно (либо явно, либо через `completed_at` при `completed = true`)
- Задача завершена в Asana (`completed = true`)

### 4. Динамический план недели (80–100)
План вычисляется автоматически на основе недельной нагрузки:
- `weekLoad = сумма Q` по всем задачам недели, у которых `due_on` попадает в текущую неделю и `Q` заполнено
- Если `weekLoad <= 80` → `plan = 80`
- Если `80 < weekLoad <= 100` → `plan = weekLoad`
- Если `weekLoad > 100` → `plan = 100`

### 5. Распределение переработки между неделями
Если задача снята в прошлой неделе, а обработана и завершена в текущей:
1. Сначала недобор прошлой недели добивается до её плана (но не больше плана)
2. Остаток Q относится к текущей неделе
3. Если прошлой неделе уже хватало до плана, вся Q идёт в текущую неделю

### 6. Новые агрегированные показатели
В таблицу `asana_stats` теперь записываются:
- `week_load` — суммарный Q задач недели
- `plan` — динамический план (80–100)
- `done_qty` — KPI "Сделано" с учётом переработки
- `to_shoot_qty` — объём "Предстоит отснять"
- `on_hand_qty` — объём товара "Принесли" и/или сфоткан, но не обработан
- `warehouse_qty` — объём задач "Взять со склада", работа не начата
- `shot_not_processed_qty` — Q задач с `shot_at`, но без `processed_at`
- `q_errors_count` — количество проблемных задач недели

### 7. Запись в asana_tasks
В таблицу `asana_tasks` записываются все новые поля:
- `q` — количество товаров из поля Q
- `product_source` — источник товара (PRINESLI или WAREHOUSE)
- `shot_at` — дата из поля "когда сфоткал"
- `processed_at` — дата из поля "когда обработал" или `completed_at`
- `week_shot` — понедельник недели по `shot_at`
- `week_processed` — понедельник недели по `processed_at`

## Структура файлов

- **Код Edge Function:** `supabase/functions/fetch-asana-stats/index.ts`
- **Документация:** `ASANA_INTEGRATION.md` (раздел 3.4)
- **Обзор бизнес-логики:** `docs/tasks-tab-overview.md`

## Развертывание

После обновления кода выполните:

```bash
# Убедитесь, что секреты установлены
supabase secrets set ASANA_PAT=your_asana_personal_access_token

# Разверните обновлённую функцию
supabase functions deploy fetch-asana-stats
```

## Обратная совместимость

- Старые поля (`completed_count`, `pending_count`, `total_plan`) сохраняются в `asana_stats` для обратной совместимости
- Поле `quantity` сохраняется в `asana_tasks` для обратной совместимости
- Фронтенд может продолжать работать со старыми полями до полного обновления

## Важные замечания

1. **Поиск кастомных полей:** Edge Function ищет поля по имени (примерное совпадение). Убедитесь, что названия полей в Asana соответствуют ожидаемым:
   - Поле Q должно содержать "Q" в названии
   - Поле "Товар" должно содержать "товар" в названии
   - Поле "когда сфоткал" должно содержать "когда сфоткал" в названии
   - Поле "когда обработал" должно содержать "когда обработал" в названии

2. **Типы полей в Asana:**
   - Q должен быть числовым полем (number)
   - "Товар" должен быть enum полем
   - "когда сфоткал" и "когда обработал" должны быть полями типа date

3. **Распределение переработки:** Логика распределения переработки требует наличия агрегатов прошлой недели в таблице `asana_stats`. Если агрегатов нет, вся Q идёт в текущую неделю.

## Тестирование

После развертывания проверьте:
1. Edge Function успешно вызывается через кнопку "Обновить данные" на вкладке "Задачи"
2. Данные корректно записываются в `asana_tasks` и `asana_stats`
3. Агрегированные показатели рассчитываются правильно
4. Переработка между неделями распределяется корректно

