-- Миграция таблицы asana_stats: добавление полей для разбивки сделанного объёма на СТМ и НЕ СТМ
-- Добавляет поля для аналитики по типу задачи (СТМ / НЕ СТМ) в рамках вкладки "Задачи"
-- 
-- Идемпотентный скрипт: можно запускать несколько раз без ошибок

-- Добавление поля для объёма сделанных товаров по задачам типа СТМ
ALTER TABLE asana_stats 
ADD COLUMN IF NOT EXISTS done_stm_qty INTEGER DEFAULT 0 NOT NULL;

-- Добавление поля для объёма сделанных товаров по задачам типа НЕ СТМ
ALTER TABLE asana_stats 
ADD COLUMN IF NOT EXISTS done_nonstm_qty INTEGER DEFAULT 0 NOT NULL;

-- Обновление комментариев к новым столбцам
COMMENT ON COLUMN asana_stats.done_stm_qty IS 'Количество товаров, сделанных по задачам с типом "СТМ" в текущей неделе. Рассчитывается на основе task_type_label из asana_tasks. Используется для разбивки карточки "Сделано" на СТМ/НЕ СТМ';
COMMENT ON COLUMN asana_stats.done_nonstm_qty IS 'Количество товаров, сделанных по задачам с типом "НЕ СТМ" в текущей неделе. Рассчитывается на основе task_type_label из asana_tasks. Используется для разбивки карточки "Сделано" на СТМ/НЕ СТМ';

-- Обновление комментария к таблице
COMMENT ON TABLE asana_stats IS 'Агрегированная статистика по неделям: динамический план, KPI "Сделано", объёмы работ и ошибки. Включает разбивку сделанного объёма на СТМ и НЕ СТМ для аналитики по типу задачи';

