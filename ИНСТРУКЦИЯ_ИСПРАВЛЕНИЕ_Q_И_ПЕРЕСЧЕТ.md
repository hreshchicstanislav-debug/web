# Инструкция: Исправление Q в задаче и пересчет статистики

## Проблемы

### Проблема 1: Q не обновляется после изменения в Asana

Если вы изменили количество товаров (Q) в задаче в Asana, но после нажатия "Обновить данные" значение "Сделано" не изменилось, это может быть из-за того, что:

1. **Задача уже закрыта** и относится к прошлой неделе - Edge Function может не получать её из Asana API (из-за параметра `completed_since`)
2. **Данные не синхронизировались** - Edge Function не обновил `asana_tasks`
3. **Статистика не пересчиталась** - даже если `asana_tasks` обновлена, `asana_stats` может содержать старые данные

### Проблема 2: Неправильный расчет переработки при наличии долга

Если у вас есть долг с прошлой недели (например, -23 товара), но переработка показывает положительное значение (например, 14), это означает, что переработка считается без учета долга.

**Правильная логика:**
- `done_qty = done_fact_this_week + carry_over_from_prev` (где `carry_over_from_prev` может быть отрицательным, если это долг)
- `overtime_qty = max(0, done_qty - plan)` (переработка должна считаться с учетом долга)

**Пример:**
- Факт недели: 94 товара
- Долг с прошлой недели: -23 товара
- Итого сделано: 94 - 23 = 71 товар
- План: 80 товаров
- Переработка должна быть: `max(0, 71 - 80) = 0` (нет переработки, так как план не выполнен)

## Решение

### Вариант 1: Автоматическое исправление (РЕКОМЕНДУЕТСЯ)

1. **Откройте Supabase SQL Editor** (Dashboard → SQL Editor → New Query)

2. **Сначала создайте функцию** (если её ещё нет):
   - Откройте файл `recalculate_asana_stats_simple.sql`
   - Скопируйте весь код
   - Вставьте в SQL Editor
   - Нажмите Run

3. **Исправьте Q в задаче и пересчитайте статистику**:
   - Откройте файл `fix_task_q_and_recalculate.sql`
   - Найдите строки:
     ```sql
     task_gid_to_fix TEXT := '1212216295467219';  -- GID задачи из Asana
     new_q_value INTEGER := 6;  -- Новое значение Q
     ```
   - Замените `'1212216295467219'` на GID вашей задачи (из URL Asana: `https://app.asana.com/.../task/1212216295467219`)
   - Замените `6` на правильное значение Q
   - Скопируйте весь код в SQL Editor
   - Нажмите Run

4. **Проверьте результат**:
   - Скрипт автоматически:
     - Обновит Q в `asana_tasks`
     - Определит, к какой неделе относится задача
     - Пересчитает статистику для этой недели
     - Покажет результаты

5. **Обновите страницу** в браузере или нажмите "Обновить данные" для обновления UI

### Вариант 2: Исправление переработки при наличии долга

Если переработка считается неправильно (показывает положительное значение, хотя должен быть 0 из-за долга):

1. **Создайте функцию** (если её ещё нет):
   - Выполните `recalculate_asana_stats_simple.sql` в Supabase SQL Editor

2. **Пересчитайте статистику для текущей недели**:
   ```sql
   SELECT * FROM recalculate_asana_stats_for_week();
   ```

   Функция автоматически:
   - Учтет долг с прошлой недели (если `carry_over_from_prev` отрицательный)
   - Правильно рассчитает `overtime_qty = max(0, done_qty - plan)`
   - Обновит все показатели в `asana_stats`

3. **Обновите страницу** в браузере

### Вариант 3: Ручное исправление Q

Если вы уже исправили Q в `asana_tasks` вручную:

1. **Создайте функцию** (если её ещё нет):
   - Выполните `recalculate_asana_stats_simple.sql` в Supabase SQL Editor

2. **Пересчитайте статистику для текущей недели**:
   ```sql
   SELECT * FROM recalculate_asana_stats_for_week();
   ```

3. **Или для конкретной недели** (если задача относится к другой неделе):
   ```sql
   SELECT * FROM recalculate_asana_stats_for_week('2025-01-13');  -- замените на нужную дату
   ```

4. **Обновите страницу** в браузере

## Как найти GID задачи

GID задачи находится в URL Asana:
```
https://app.asana.com/1/1208507351529750/project/1210252517175882/task/1212216295467219
                                                                        ^^^^^^^^^^^^^^^^
                                                                        Это GID задачи
```

## Важные замечания

⚠️ **ВНИМАНИЕ**: При следующем вызове Edge Function `fetch-asana-stats` (кнопка "Обновить данные") данные из Asana API могут перезаписать ваши ручные исправления в `asana_tasks`, если:
- Задача всё ещё видна в Asana API
- Edge Function получает эту задачу при синхронизации

**Рекомендация**: После исправления данных в Supabase, **обязательно исправьте Q в самой Asana**, чтобы при следующей синхронизации данные были правильными.

## Проверка результата

После выполнения скрипта проверьте:

1. **Q в задаче обновлено**:
   ```sql
   SELECT asana_task_gid, task_name, q, updated_at
   FROM asana_tasks
   WHERE asana_task_gid = '1212216295467219';  -- ваш GID
   ```

2. **Статистика пересчитана**:
   ```sql
   SELECT week_start_date, done_fact_this_week, done_qty, updated_at
   FROM asana_stats
   WHERE week_start_date = (
     SELECT DATE_TRUNC('week', CURRENT_DATE)::date + INTERVAL '1 day' * (1 - EXTRACT(DOW FROM DATE_TRUNC('week', CURRENT_DATE)::date))
   );
   ```

3. **Обновите UI** - нажмите "Обновить данные" или перезагрузите страницу

## Если проблема сохраняется

Если после выполнения скрипта данные всё ещё неверны:

1. Проверьте, что задача действительно обновлена в `asana_tasks`
2. Проверьте, к какой неделе относится задача (`week_processed`, `week_shot`, `week_start_date`)
3. Убедитесь, что задача имеет `completed = true` и `q > 0`
4. Проверьте, что функция `recalculate_asana_stats_for_week` создана успешно
5. Проверьте логи выполнения SQL-скрипта на наличие ошибок

