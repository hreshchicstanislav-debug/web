# Анализ предложения по изменению показателей

## Текущая логика

### 1. "Предстоит отснять" (`to_shoot_qty`)

**Текущая формула:**
```sql
Сумма q для задач, где:
- due_on попадает в диапазон [weekStartStr, weekEndStr] (дедлайн в текущей неделе)
- q > 0
- completed != true (задача не завершена)
```

**Что включает:**
- ✅ Задачи с дедлайном в текущей неделе
- ✅ Незавершенные задачи
- ✅ Может включать задачи, которые еще не начаты (`shot_at IS NULL`)
- ✅ Может включать задачи, которые уже сфотканы, но не обработаны

**Проблема (по вашему замечанию):**
- Название "Предстоит отснять" не отражает, что нужно именно обработать
- Включает задачи, которые уже сфотканы, но еще не обработаны
- Не разделяет "что нужно сделать" и "что уже начато"

---

### 2. "Сфоткано, но не обработано" (`shot_not_processed_qty`)

**Текущая формула:**
```sql
Сумма q для задач, где:
- week_shot = weekStartStr (сфоткано на ЭТОЙ неделе)
- shot_at IS NOT NULL (есть дата съёмки)
- processed_at IS NULL (нет даты обработки)
- completed != true (задача не завершена)
- q > 0
```

**Что включает:**
- ✅ Только задачи, сфотканные на ТЕКУЩЕЙ неделе
- ✅ Только задачи, которые еще не обработаны
- ❌ НЕ включает задачи, сфотканные раньше (даже если они не обработаны)

**Проблема (по вашему замечанию):**
- Показывает только то, что сфоткано на ЭТОЙ неделе
- Не показывает накопительный долг (задачи, сфотканные раньше, но не обработанные)
- Если задача сфоткана месяц назад, но не обработана, и дедлайн перенесен на месяц вперед - она НЕ попадает в этот показатель

---

## Ваше предложение

### 1. "Предстоит обработать (на этой неделе)" (было "Предстоит отснять")

**Новая логика:**
- Задачи с дедлайном в текущей неделе
- Которые еще не обработаны (`processed_at IS NULL`)
- Незавершенные (`completed != true`)

**Что это дает:**
- ✅ Показывает, что нужно обработать СЕЙЧАС (на этой неделе)
- ✅ Не важно, сфоткано или нет - важно, что нужно обработать
- ✅ Фокус на обработке, а не на съёмке

**Вопросы:**
- Нужно ли включать задачи, которые еще не сфотканы? (если `shot_at IS NULL`)
- Или только те, которые уже сфотканы, но не обработаны?

---

### 2. "Сфоткано, но не обработано" (накопительный показатель)

**Новая логика:**
- Все задачи, которые сфотканы (`shot_at IS NOT NULL`)
- Но не обработаны (`processed_at IS NULL`)
- Незавершенные (`completed != true`)
- Дедлайн НЕ в текущей неделе (или любой дедлайн, но не в текущей неделе)

**Что это дает:**
- ✅ Показывает накопительный долг по обработке
- ✅ Включает задачи, сфотканные давно, но не обработанные
- ✅ Показывает "что накопилось" за все время

**Вопросы:**
- Нужно ли исключать задачи с дедлайном в текущей неделе? (чтобы не дублировать с "Предстоит обработать")
- Или показывать все сфотканные, но не обработанные задачи, независимо от дедлайна?

---

## Сравнение текущей и предлагаемой логики

### Сценарий 1: Задача сфоткана на этой неделе, дедлайн в этой неделе, не обработана

**Текущая логика:**
- ✅ "Предстоит отснять" — входит (дедлайн в этой неделе)
- ✅ "Сфоткано, но не обработано" — входит (сфоткана на этой неделе)

**Предлагаемая логика:**
- ✅ "Предстоит обработать" — входит (дедлайн в этой неделе, не обработана)
- ❌ "Сфоткано, но не обработано" — НЕ входит (дедлайн в текущей неделе, исключаем)

**Результат:** Задача попадает только в "Предстоит обработать" (нет дублирования)

---

### Сценарий 2: Задача сфоткана месяц назад, дедлайн перенесен на месяц вперед, не обработана

**Текущая логика:**
- ✅ "Предстоит отснять" — входит (дедлайн в текущей неделе)
- ❌ "Сфоткано, но не обработано" — НЕ входит (сфоткана не на этой неделе)

**Предлагаемая логика:**
- ✅ "Предстоит обработать" — входит (дедлайн в текущей неделе, не обработана)
- ❌ "Сфоткано, но не обработано" — НЕ входит (дедлайн в текущей неделе, исключаем)

**Результат:** Задача попадает только в "Предстоит обработать"

---

### Сценарий 3: Задача сфоткана месяц назад, дедлайн перенесен на месяц вперед (НЕ в текущей неделе), не обработана

**Текущая логика:**
- ❌ "Предстоит отснять" — НЕ входит (дедлайн не в текущей неделе)
- ❌ "Сфоткано, но не обработано" — НЕ входит (сфоткана не на этой неделе)

**Предлагаемая логика:**
- ❌ "Предстоит обработать" — НЕ входит (дедлайн не в текущей неделе)
- ✅ "Сфоткано, но не обработано" — входит (сфоткана, не обработана, дедлайн не в текущей неделе)

**Результат:** Задача попадает в "Сфоткано, но не обработано" (показывает накопительный долг)

---

### Сценарий 4: Задача еще не сфоткана, дедлайн в текущей неделе

**Текущая логика:**
- ✅ "Предстоит отснять" — входит (дедлайн в этой неделе)
- ❌ "Сфоткано, но не обработано" — НЕ входит (не сфоткана)

**Предлагаемая логика:**
- ❓ "Предстоит обработать" — зависит от определения (если включать задачи без `shot_at`, то входит)
- ❌ "Сфоткано, но не обработано" — НЕ входит (не сфоткана)

**Результат:** Зависит от определения "Предстоит обработать"

---

## Анализ вашего предложения

### Преимущества

1. **Четкое разделение:**
   - "Предстоит обработать" — что нужно сделать СЕЙЧАС (на этой неделе)
   - "Сфоткано, но не обработано" — что накопилось за все время

2. **Накопительный показатель:**
   - Показывает реальный долг по обработке
   - Включает задачи, сфотканные давно, но не обработанные

3. **Нет дублирования:**
   - Задача не может попасть в оба показателя одновременно
   - Четкое разделение по дедлайну (в текущей неделе / не в текущей неделе)

4. **Более точное название:**
   - "Предстоит обработать" точнее отражает суть (нужно обработать, а не отснять)

---

### Вопросы для уточнения

1. **"Предстоит обработать" — нужно ли включать задачи без `shot_at`?**
   - Если да: показывает весь объем работы на неделю (и съёмка, и обработка)
   - Если нет: показывает только то, что уже сфоткано и нужно обработать

2. **"Сфоткано, но не обработано" — нужно ли исключать задачи с дедлайном в текущей неделе?**
   - Если да: четкое разделение (текущая неделя / накопительный долг)
   - Если нет: показывает весь накопительный долг, включая текущую неделю

3. **Что делать с задачами, которые уже обработаны, но не закрыты?**
   - Сейчас `processed_at IS NOT NULL` означает, что задача обработана
   - Но если `completed = false`, задача все еще не закрыта
   - Нужно ли это учитывать?

---

## Рекомендации

### Вариант 1: Строгое разделение (рекомендуется)

**"Предстоит обработать (на этой неделе)":**
```sql
Сумма q для задач, где:
- due_on в текущей неделе
- processed_at IS NULL (не обработана)
- completed != true
- q > 0
```

**"Сфоткано, но не обработано" (накопительный):**
```sql
Сумма q для задач, где:
- shot_at IS NOT NULL (сфоткана)
- processed_at IS NULL (не обработана)
- completed != true
- due_on НЕ в текущей неделе (или due_on IS NULL)
- q > 0
```

**Преимущества:**
- ✅ Нет дублирования
- ✅ Четкое разделение (текущая неделя / накопительный долг)
- ✅ Показывает реальный долг по обработке

---

### Вариант 2: С учетом съёмки

**"Предстоит обработать (на этой неделе)":**
```sql
Сумма q для задач, где:
- due_on в текущей неделе
- processed_at IS NULL (не обработана)
- shot_at IS NOT NULL (уже сфоткана) -- ДОБАВЛЕНО
- completed != true
- q > 0
```

**"Сфоткано, но не обработано" (накопительный):**
```sql
Сумма q для задач, где:
- shot_at IS NOT NULL (сфоткана)
- processed_at IS NULL (не обработана)
- completed != true
- (due_on НЕ в текущей неделе OR due_on IS NULL) -- ДОБАВЛЕНО
- q > 0
```

**Преимущества:**
- ✅ Показывает только то, что уже можно обработать (уже сфоткано)
- ✅ "Предстоит обработать" не включает задачи, которые еще нужно сфоткать

---

## Вывод

Ваше предложение логично и решает проблему накопительного долга. Основные изменения:

1. **"Предстоит отснять" → "Предстоит обработать"**
   - Фокус на обработке, а не на съёмке
   - Показывает, что нужно сделать на этой неделе

2. **"Сфоткано, но не обработано" → накопительный показатель**
   - Показывает весь долг по обработке (не только текущей недели)
   - Включает задачи, сфотканные давно, но не обработанные

3. **Четкое разделение:**
   - Текущая неделя (по дедлайну) → "Предстоит обработать"
   - Накопительный долг (не в текущей неделе) → "Сфоткано, но не обработано"

Это более логично и полезно для операционного контроля.

