# Спецификация новой логики KPI для вкладки "Задачи"

## Цель изменения

1. **Убрать путаницу между показателями "Предстоит отснять" и "Сфоткано, но не обработано"**
   - Текущая логика приводит к тому, что одна и та же задача может попадать в оба показателя одновременно
   - Название "Предстоит отснять" не отражает реальную задачу (нужно обработать, а не отснять)

2. **Разделить операционную нагрузку текущей недели и накопленный долг**
   - Операционные показатели должны показывать, что нужно сделать СЕЙЧАС (на этой неделе)
   - Накопительные показатели должны показывать долг, накопленный за все время

3. **Сделать путь задачи от начала до конца предсказуемым и непротиворечивым**
   - Задача должна проходить через четкие состояния без дублирования
   - Каждое состояние должно иметь однозначное определение

---

## Текущие KPI (как есть)

| Показатель | Название карточки в UI | Поле в `asana_stats` | Формула/условие |
|------------|------------------------|---------------------|-----------------|
| `done_qty` | "Сделано" | `done_qty` | `done_fact_this_week + carry_over_from_prev` |
| `plan` | "План недели" | `plan` | Динамический план 80-100 (на фронтенде принудительно 80) |
| `remaining_to_plan` | "До выполнения плана" | `remaining_to_plan` | `max(0, plan - done_fact_this_week)` (на фронтенде пересчитывается с `done_qty`) |
| `to_shoot_qty` | "Предстоит отснять" | `to_shoot_qty` | Сумма `q` задач с `due_on` в текущей неделе, `completed != true`, `q > 0` |
| `on_hand_qty` | "Уже на руках" | `on_hand_qty` | Сумма `q` задач с `due_on` в текущей неделе, `product_source = 'PRINESLI'`, `shot_at IS NULL`, `completed != true`, `q > 0` |
| `warehouse_qty` | "Нужно взять со склада" | `warehouse_qty` | Сумма `q` задач с `due_on` в текущей неделе, `product_source = 'WAREHOUSE'`, `shot_at IS NULL`, `processed_at IS NULL`, `completed != true`, `q > 0` |
| `shot_not_processed_qty` | "Сфоткано, но не обработано" | `shot_not_processed_qty` | Сумма `q` задач с `week_shot = текущая неделя`, `shot_at IS NOT NULL`, `processed_at IS NULL`, `completed != true`, `q > 0` |

**Проблемы текущей логики:**
- `to_shoot_qty` включает задачи, которые уже обработаны (но не закрыты)
- `shot_not_processed_qty` показывает только текущую неделю, не включает накопительный долг
- Задачи могут попадать в оба показателя одновременно (дублирование)

---

## Новая целевая модель KPI

### Операционные показатели текущей недели

Эти показатели отражают работу, которую нужно выполнить **на этой неделе** (по дедлайну `due_on`).

#### 1. "Уже на руках" (`on_hand_qty`)

**Определение:** Товары, которые физически находятся у фотографа (принесли), но еще не сфотографированы.

**Условия попадания задачи:**
- `due_on` в текущей неделе (понедельник–воскресенье)
- `product_source = 'PRINESLI'`
- `shot_at IS NULL` (товар еще не сфотографирован)
- `completed != true`
- `q > 0`

**Условия выхода задачи:**
- `shot_at` заполнено (товар сфотографирован) → переходит в "Обработать на этой неделе" или "Сфоткано, но не обработано"
- `due_on` перенесен на другую неделю → переходит в соответствующий показатель другой недели
- `completed = true` → переходит в "Сделано"

**Изменения:** Без изменений (логика корректна)

---

#### 2. "Нужно взять со склада" (`warehouse_qty`)

**Определение:** Товары, которые нужно взять самому со склада, работа еще не начата.

**Условия попадания задачи:**
- `due_on` в текущей неделе (понедельник–воскресенье)
- `product_source = 'WAREHOUSE'`
- `shot_at IS NULL` (работа не начата)
- `processed_at IS NULL` (работа не начата)
- `completed != true`
- `q > 0`

**Условия выхода задачи:**
- `shot_at` заполнено → переходит в "Обработать на этой неделе" или "Сфоткано, но не обработано"
- `due_on` перенесен на другую неделю → переходит в соответствующий показатель другой недели
- `completed = true` → переходит в "Сделано"

**Изменения:** Без изменений (логика корректна)

---

#### 3. "Обработать на этой неделе" (`to_process_this_week`) — **НОВЫЙ показатель**

**Определение:** Задачи с дедлайном в текущей неделе, которые нужно обработать (сфотканы или нет, но не обработаны).

**Условия попадания задачи:**
- `due_on` в текущей неделе (понедельник–воскресенье)
- `processed_at IS NULL` (не обработана) — **КЛЮЧЕВОЕ УСЛОВИЕ**
- `completed != true`
- `q > 0`

**Условия выхода задачи:**
- `processed_at` заполнено → переходит в "Сделано" (если `completed = true`)
- `due_on` перенесен на другую неделю → переходит в "Сфоткано, но не обработано" (накопительный долг)
- `completed = true` → переходит в "Сделано"

**Изменения:**
- Переименование: `to_shoot_qty` → `to_process_this_week`
- Добавлено условие: `processed_at IS NULL`
- Название карточки: "Предстоит отснять" → "Обработать на этой неделе"

---

### Накопительные показатели

Эти показатели отражают долг, накопленный за все время, независимо от недели.

#### 4. "Сфоткано, но не обработано (накопительный долг)" (`shot_not_processed_qty`)

**Определение:** Все задачи, которые сфотканы, но не обработаны, и дедлайн НЕ в текущей неделе (или `due_on IS NULL`).

**Условия попадания задачи:**
- `shot_at IS NOT NULL` (сфоткана)
- `processed_at IS NULL` (не обработана)
- `completed != true`
- `q > 0`
- `due_on` НЕ в текущей неделе (или `due_on IS NULL`) — **КЛЮЧЕВОЕ УСЛОВИЕ**

**Условия выхода задачи:**
- `processed_at` заполнено → переходит в "Сделано" (если `completed = true`)
- `due_on` перенесен в текущую неделю → переходит в "Обработать на этой неделе"
- `completed = true` → переходит в "Сделано"

**Изменения:**
- Убрано условие: `week_shot = текущая неделя`
- Добавлено условие: `due_on` НЕ в текущей неделе (или `due_on IS NULL`)
- Название карточки: без изменений (но логика становится накопительной)

---

### Итоговые KPI недели

Эти показатели отражают результат работы за неделю.

#### 5. "Сделано" (`done_qty`)

**Определение:** Итоговое количество товаров, зачтенных за неделю (с учетом переработки/долга с прошлой недели).

**Формула:**
```
done_qty = done_fact_this_week + carry_over_from_prev
```

**Изменения:** Без изменений (логика корректна)

---

#### 6. "План недели" (`plan`)

**Определение:** План недели (статический 80 или динамический 80-100).

**Формула:**
```
Если week_load <= 80 → plan = 80
Если 80 < week_load <= 100 → plan = week_load
Если week_load > 100 → plan = 100
```

**Изменения:** Без изменений (но на фронтенде принудительно 80)

---

#### 7. "До выполнения плана" (`remaining_to_plan`)

**Определение:** Сколько товаров осталось до выполнения плана.

**Формула:**
```
remaining_to_plan = max(0, plan - done_qty)
```

**Изменения:** Без изменений (на фронтенде пересчитывается с `done_qty`)

---

## Путь задачи по состояниям

Жизненный цикл задачи в терминах KPI:

```
1. Начальное состояние:
   ├─→ "Уже на руках" (если product_source = 'PRINESLI' и shot_at IS NULL)
   └─→ "Нужно взять со склада" (если product_source = 'WAREHOUSE' и shot_at IS NULL)

2. После съёмки (shot_at заполнено):
   ├─→ Если due_on в текущей неделе → "Обработать на этой неделе"
   └─→ Если due_on НЕ в текущей неделе → "Сфоткано, но не обработано" (накопительный долг)

3. После обработки (processed_at заполнено):
   └─→ "Сделано" (если completed = true)

4. Если дедлайн перенесен:
   ├─→ Из "Обработать на этой неделе" → "Сфоткано, но не обработано" (накопительный долг)
   └─→ Из "Уже на руках" / "Нужно взять со склада" → соответствующий показатель другой недели
```

**Важно:** Одна и та же задача НЕ может одновременно попадать в:
- "Обработать на этой неделе" И "Сфоткано, но не обработано" (разделение по `due_on`)
- "Уже на руках" И "Нужно взять со склада" (разделение по `product_source`)
- Любой операционный показатель И "Сделано" (разделение по `completed`)

---

## Изменения по сравнению с текущей логикой

| Аспект | Было | Стало |
|--------|------|-------|
| **Название показателя** | "Предстоит отснять" (`to_shoot_qty`) | "Обработать на этой неделе" (`to_process_this_week`) |
| **Условие для "Обработать на этой неделе"** | `due_on` в текущей неделе, `completed != true`, `q > 0` | `due_on` в текущей неделе, `processed_at IS NULL`, `completed != true`, `q > 0` |
| **Логика "Сфоткано, но не обработано"** | Только текущая неделя (`week_shot = текущая неделя`) | Накопительный долг (все задачи, где `shot_at IS NOT NULL`, `processed_at IS NULL`, `due_on НЕ в текущей неделе`) |
| **Разделение текущей недели и долга** | Неявное (по `week_shot`) | Явное (по `due_on` в текущей неделе или нет) |
| **Дублирование задач** | Задача может попадать в "Предстоит отснять" И "Сфоткано, но не обработано" | Задача попадает либо в "Обработать на этой неделе", либо в "Сфоткано, но не обработано" (разделение по `due_on`) |

**Ключевые отличия:**

1. **Добавлено условие `processed_at IS NULL`** для "Обработать на этой неделе"
   - Исключает задачи, которые уже обработаны (даже если не закрыты)
   - Фокус на обработке, а не на съёмке

2. **Убрано условие `week_shot = текущая неделя`** для "Сфоткано, но не обработано"
   - Показывает весь накопительный долг по обработке
   - Включает задачи, сфотканные давно, но не обработанные

3. **Добавлено условие `due_on НЕ в текущей неделе`** для "Сфоткано, но не обработано"
   - Четкое разделение: текущая неделя (по дедлайну) vs накопительный долг
   - Исключает дублирование с "Обработать на этой неделе"

---

## Требования к реализации (backend/SQL/frontend)

### Backend (Edge Function)

- [ ] Заменить расчёт `to_shoot_qty` на `to_process_this_week` с условием `processed_at IS NULL`
- [ ] Изменить расчёт `shot_not_processed_qty` на накопительный (убрать условие `week_shot = текущая неделя`, добавить условие `due_on НЕ в текущей неделе`)
- [ ] Обновить возвращаемые поля в JSON ответе Edge Function (добавить `to_process_this_week`, сохранить `to_shoot_qty` для обратной совместимости или переименовать)
- [ ] Обновить функцию `computeWeekAggregates()` для новой логики
- [ ] Обновить расчёт `week_load` (использовать `to_process_this_week` вместо `to_shoot_qty`)

### SQL (для пересчёта статистики)

- [ ] Скорректировать расчёт `to_process_this_week` в функции `recalculate_asana_stats_for_week()` (добавить условие `processed_at IS NULL`)
- [ ] Скорректировать расчёт `shot_not_processed_qty` на накопительный (убрать условие `week_shot = текущая неделя`, добавить условие `due_on НЕ в текущей неделе`)
- [ ] Обновить INSERT/UPDATE в `asana_stats` (использовать `to_process_this_week` вместо `to_shoot_qty`)
- [ ] Обновить расчёт `week_load` (использовать `to_process_this_week` вместо `to_shoot_qty`)

### Frontend

- [ ] Переименовать карточку "Предстоит отснять" в "Обработать на этой неделе"
- [ ] Обновить нормализацию данных в `getAsanaStats()` (маппить `to_process_this_week` вместо `to_shoot_qty`, с fallback на старое поле для обратной совместимости)
- [ ] Обновить функцию `updateTasksCards()` (использовать `toProcessThisWeek` вместо `toShootQty`)
- [ ] Обновить функцию `renderTasks()` (использовать новое название и поле)
- [ ] Обновить расчёт `week_load` (использовать `toProcessThisWeek` вместо `toShootQty`)
- [ ] Обновить комментарии и мета-информацию в карточках

### Схема базы данных (опционально)

- [ ] Вариант 1: Переименовать поле `to_shoot_qty` в `to_process_this_week` в таблице `asana_stats`
- [ ] Вариант 2: Добавить новое поле `to_process_this_week` и заполнить из `to_shoot_qty` (для обратной совместимости)
- [ ] Обновить комментарии к полям в `asana_stats`

**Примечание:** Изменение логики `shot_not_processed_qty` не требует изменения схемы БД, только изменение SQL-запроса.

---

## Ничего не делаем в этой итерации

**Важно:** На этом шаге НЕ требуется:

- ❌ Никаких деплоев Edge Function
- ❌ Никаких миграций схемы базы данных
- ❌ Никаких изменений в коде Edge Function
- ❌ Никаких изменений в коде frontend
- ❌ Никаких изменений в SQL функциях

**Это чисто спецификация и согласование новой целевой модели KPI.**

Следующие шаги (реализация) будут выполняться отдельно, на основе этой спецификации.

---

**Версия документа:** 1.0  
**Дата создания:** 2025-01-XX  
**Статус:** Спецификация (не реализовано)
