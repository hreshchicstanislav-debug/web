# Полное описание показателей вкладки "Задачи" и предложения по изменению

## Цель документа

Этот документ содержит:
1. Полное описание всех текущих показателей (вкладок) во вкладке "Задачи"
2. Как они считаются (формулы, SQL, код)
3. Предложения по изменению логики
4. Обоснование изменений
5. Технические детали для реализации

Документ предназначен для анализа и переделки логики показателей.

---

## Контекст и важные особенности

### Особенности работы с дедлайнами

**ВАЖНО:** Дедлайны (`due_on`) в Asana не являются строгими обязательствами. Пользователь:
- Получает задачи с дедлайнами, которые ставятся "от балды" без понимания реальной нагрузки
- Сам распределяет работу, ориентируясь на план недели (80 товаров)
- Переносит дедлайны в Asana, если не успевает выполнить задачи в срок
- Использует дедлайны как ориентир для планирования, а не как жесткое требование

**Следствие:** Показатели, основанные на `due_on`, должны отражать "что планируется на эту неделю", а не "что строго должно быть сделано".

### Процесс работы с товарами

1. **Товар может быть:**
   - На руках (`product_source = 'PRINESLI'`) — товар принесли
   - Нужно взять со склада (`product_source = 'WAREHOUSE'`) — нужно взять самому

2. **Работа с товаром:**
   - Товар сфотографирован (`shot_at` заполнено)
   - Товар может быть обработан сразу в тот же день (`processed_at` заполнено в тот же день)
   - Или товар переходит в статус "предстоит обработать" (если `shot_at` есть, но `processed_at` нет)

3. **Если не успел обработать:**
   - Задачи из "предстоит обработать" (с дедлайном в текущей неделе) переходят в "сфоткано, но не обработано" (накопительный долг)
   - Это происходит, когда дедлайн переносится на будущее, но товар уже сфотографирован

---

## Текущие показатели (вкладки)

### 1. "Сделано" (`done_qty`)

**Отображается:** В карточке "Сделано" (`#completedCount`)

**Что отражает:** Итоговое количество товаров, зачтенных за неделю (с учетом переработки/долга с прошлой недели)

**Формула:**
```
done_qty = done_fact_this_week + carry_over_from_prev
```

**Где считается:**
- Edge Function: `supabase/functions/fetch-asana-stats/index.ts`, строка 853
- SQL: `recalculate_asana_stats_simple.sql`, строка 174

**Детали расчета:**

**`done_fact_this_week`** — фактический объем недели:
```sql
-- Сумма q для задач, где:
-- - q > 0
-- - completed = true
-- - Фактическая неделя задачи совпадает с текущей неделей
-- 
-- Фактическая неделя определяется по приоритету:
-- 1. week_processed (если processed_at заполнено)
-- 2. week_shot (если processed_at пусто, но shot_at заполнено)
-- 3. week_completed (если задача завершена, но нет shot_at и processed_at)
```

**`carry_over_from_prev`** — переработка/долг с прошлой недели:
```sql
-- Берется из asana_stats предыдущей недели:
-- carry_over_from_prev = previousWeekStats.overtime_qty
-- 
-- Может быть:
-- - Положительным (переработка) — если сделано больше плана
-- - Отрицательным (долг) — если сделано меньше плана
```

**SQL для расчета:**
```sql
-- done_fact_this_week
SELECT COALESCE(SUM(q), 0)
FROM asana_tasks
WHERE (
  week_processed = week_start_val
  OR (week_processed IS NULL AND week_shot = week_start_val)
  OR (week_processed IS NULL AND week_shot IS NULL AND completed_at IS NOT NULL 
      AND DATE_TRUNC('week', completed_at::date)::date = week_start_val)
)
AND completed = true
AND q > 0;

-- carry_over_from_prev
SELECT COALESCE(prev_stats.carry_over_from_prev, prev_stats.overtime_qty, 0)
FROM asana_stats prev_stats
WHERE prev_stats.week_start_date = prev_week_start_val
LIMIT 1;
```

**Код Edge Function:**
```typescript
// Функция computeWeekAggregates(), цикл по factTasks (строки 443-470)
// done_fact_this_week суммируется из задач, где getFactWeek(task) === currentWeek

// carry_over_from_prev получается из предыдущей недели (строки 833-851)
```

**Использование на фронтенде:**
- `app.js`, функция `updateTasksCards()`, строка 1980: `completedValue.textContent = doneQty`
- Отображается как основное значение карточки "Сделано"

**Мета-информация в карточке:**
- `done_fact_this_week` — фактический объем недели
- `carry_over_from_prev` — переработка/долг с прошлой недели
- `done_stm_qty` / `done_nonstm_qty` — разделение по СТМ/НЕ СТМ

---

### 2. "План недели" (`plan`)

**Отображается:** В карточке "План недели" (`#planValue`)

**Что отражает:** Динамический план недели (80-100 товаров), рассчитанный на основе недельной нагрузки

**Формула:**
```
Если week_load <= 80 → plan = 80
Если 80 < week_load <= 100 → plan = week_load
Если week_load > 100 → plan = 100
```

**Где считается:**
- Edge Function: `computeDynamicPlan(weekLoad: number)`, строка 516
- SQL: `recalculate_asana_stats_simple.sql`, строки 95-102

**Детали расчета:**

**`week_load`** — недельная нагрузка:
```sql
week_load = done_fact_this_week + to_shoot_qty
```

**SQL для расчета:**
```sql
-- week_load
week_load_val := done_fact + to_shoot;

-- plan
IF week_load_val <= 80 THEN
  plan_val := 80;
ELSIF week_load_val <= 100 THEN
  plan_val := week_load_val;
ELSE
  plan_val := 100;
END IF;
```

**Код Edge Function:**
```typescript
// Функция computeDynamicPlan(weekLoad: number) (строка 516)
function computeDynamicPlan(weekLoad: number): number {
  if (weekLoad <= 80) return 80;
  if (weekLoad <= 100) return weekLoad;
  return 100;
}
```

**Важно:** План сравнивается с `done_fact_this_week` (не с `done_qty`), так как переработка с прошлой недели не должна влиять на план текущей недели.

**Использование на фронтенде:**
- `app.js`, функция `updateTasksCards()`, строка 1985: `planValue.textContent = plan`
- Отображается как основное значение карточки "План недели"
- Мета-информация: `weekLoad` — нагрузка недели

---

### 3. "Предстоит отснять" (`to_shoot_qty`)

**Отображается:** В карточке "Предстоит отснять" (`#pendingCount`)

**Что отражает (текущая логика):** Объем задач с дедлайном в текущей неделе, которые еще не завершены

**Формула (текущая):**
```sql
-- Сумма q для задач, где:
-- - due_on попадает в диапазон [weekStartStr, weekEndStr] (дедлайн в текущей неделе)
-- - q > 0
-- - completed != true (задача не завершена)
```

**Где считается:**
- Edge Function: `computeWeekAggregates()`, цикл по `planTasks` (строки 473-499)
- SQL: `recalculate_asana_stats_simple.sql`, строки 83-90

**SQL для расчета:**
```sql
SELECT COALESCE(SUM(q), 0)
INTO to_shoot
FROM asana_tasks
WHERE due_on >= week_start_val 
  AND due_on <= week_end_val
  AND q > 0
  AND completed != true;
```

**Код Edge Function:**
```typescript
// Функция computeWeekAggregates(), цикл по planTasks (строки 473-499)
// planTasks получаются из запроса:
// SELECT * FROM asana_tasks WHERE due_on >= weekStartStr AND due_on <= weekEndStr

for (const task of planTasks) {
  if (!task.completed && q > 0) {
    toShootQty += q;
  }
}
```

**Проблемы текущей логики:**
1. Название "Предстоит отснять" не отражает, что нужно именно обработать (а не отснять)
2. Включает задачи, которые уже сфотканы, но не обработаны
3. Включает задачи, которые уже обработаны, но не закрыты (`completed != true`)
4. Не разделяет "что нужно сделать сейчас" и "что накопилось"

**Использование на фронтенде:**
- `app.js`, функция `updateTasksCards()`, строка 1986: `pendingValue.textContent = toShootQty`
- Отображается как основное значение карточки "Предстоит отснять"

---

### 4. "До выполнения плана" (`remaining_to_plan`)

**Отображается:** В карточке "До выполнения плана" (`#remainingCount`)

**Что отражает:** Сколько осталось сделать до выполнения плана (с учетом долга/переработки)

**Формула (текущая в БД):**
```sql
remaining_to_plan = GREATEST(0, plan - done_fact_this_week)
```

**Формула (на фронтенде, исправленная):**
```javascript
remaining_to_plan = Math.max(0, plan - done_qty)
// где done_qty = done_fact_this_week + carry_over_from_prev
```

**Где считается:**
- Edge Function: строка 830 (в БД)
- SQL: `recalculate_asana_stats_simple.sql`, строка 162
- Фронтенд: `app.js`, функция `getAsanaStats()`, строка 1914 (пересчитывается)

**SQL для расчета:**
```sql
remaining_to_plan := GREATEST(0, plan_val - done_fact);
```

**Код фронтенда:**
```javascript
// app.js, функция getAsanaStats(), строка 1914
remainingToPlan: Math.max(80 - doneQty, 0), // План всегда 80, учитываем долг/переработку
```

**Важно:** На фронтенде пересчитывается с учетом долга/переработки, так как план всегда 80 (статический), а в БД может быть динамический план.

**Использование на фронтенде:**
- `app.js`, функция `updateTasksCards()`, строка 1987: `remainingValue.textContent = remainingToPlan`
- Визуальное оформление зависит от знака: если `remaining_to_plan > 0` — красный, если `<= 0` — зеленый (перевыполнение)

---

### 5. "Уже на руках" (`on_hand_qty`)

**Отображается:** В операционной карточке "Уже на руках" (`#kpiOnHandValue`)

**Что отражает:** Товары, которые физически находятся у фотографа (принесли), но еще не сфотографированы

**Формула:**
```sql
-- Сумма q для задач, где:
-- - due_on попадает в диапазон [weekStartStr, weekEndStr] (дедлайн в текущей неделе)
-- - q > 0
-- - completed != true (задача не завершена)
-- - product_source = 'PRINESLI' (товар принесли)
-- - shot_at IS NULL (товар еще не сфотографирован, поэтому все еще на руках)
```

**Где считается:**
- Edge Function: `computeWeekAggregates()`, цикл по `planTasks` (строка 487)
- SQL: `recalculate_asana_stats_simple.sql`, строки 114-123

**SQL для расчета:**
```sql
SELECT COALESCE(SUM(q), 0)
INTO on_hand
FROM asana_tasks
WHERE product_source = 'PRINESLI'
  AND completed != true
  AND shot_at IS NULL
  AND due_on >= week_start_val
  AND due_on <= week_end_val
  AND q > 0;
```

**Код Edge Function:**
```typescript
// Функция computeWeekAggregates(), цикл по planTasks (строка 487)
if (!task.completed && task.product_source === PRODUCT_SOURCE_PRINESLI && !task.shot_at) {
  onHandQty += q;
}
```

**Важно:** Товар попадает в "Уже на руках" только если он ЕЩЁ НЕ сфотографирован. После съёмки товар возвращается, поэтому он больше не "на руках".

**Использование на фронтенде:**
- `app.js`, функция `updateTasksCards()`, строка 2005: `onHandValueEl.textContent = onHandQty`
- Отображается в операционной карточке "Уже на руках"

---

### 6. "Нужно взять со склада" (`warehouse_qty`)

**Отображается:** В операционной карточке "Нужно взять со склада" (`#kpiWarehouseValue`)

**Что отражает:** Товары, которые нужно взять самому со склада, работа еще не начата

**Формула:**
```sql
-- Сумма q для задач, где:
-- - due_on попадает в диапазон [weekStartStr, weekEndStr] (дедлайн в текущей неделе)
-- - q > 0
-- - completed != true (задача не завершена)
-- - product_source = 'WAREHOUSE' (нужно взять со склада)
-- - shot_at IS NULL (работа не начата)
-- - processed_at IS NULL (работа не начата)
```

**Где считается:**
- Edge Function: `computeWeekAggregates()`, цикл по `planTasks` (строки 491-496)
- SQL: `recalculate_asana_stats_simple.sql`, строки 125-135

**SQL для расчета:**
```sql
SELECT COALESCE(SUM(q), 0)
INTO warehouse
FROM asana_tasks
WHERE product_source = 'WAREHOUSE'
  AND completed != true
  AND shot_at IS NULL
  AND processed_at IS NULL
  AND due_on >= week_start_val
  AND due_on <= week_end_val
  AND q > 0;
```

**Код Edge Function:**
```typescript
// Функция computeWeekAggregates(), цикл по planTasks (строки 491-496)
if (!task.completed && task.product_source === PRODUCT_SOURCE_WAREHOUSE && !task.shot_at && !task.processed_at) {
  warehouseQty += q;
}
```

**Важно:** Товар попадает в "Нужно взять со склада" только если работа еще не начата (нет `shot_at` и `processed_at`).

**Использование на фронтенде:**
- `app.js`, функция `updateTasksCards()`, строка 2006: `warehouseValueEl.textContent = warehouseQty`
- Отображается в операционной карточке "Нужно взять со склада"

**Связь с "Уже на руках":**
- "Уже на руках" + "Нужно взять со склада" = сумма товаров из задач на эту неделю, которые предстоит выполнить
- Это все товары с дедлайном в текущей неделе, работа по которым еще не начата

---

### 7. "Сфоткано, но не обработано" (`shot_not_processed_qty`)

**Отображается:** В операционной карточке "Сфоткано, но не обработано" (`#kpiShotNotProcessedValue`)

**Что отражает (текущая логика):** Товары, которые сфотографированы на ЭТОЙ неделе, но еще не обработаны

**Формула (текущая):**
```sql
-- Сумма q для задач, где:
-- - q > 0
-- - week_shot = weekStartStr (сфоткано на ЭТОЙ неделе)
-- - completed != true (задача не завершена)
-- - shot_at IS NOT NULL (есть дата съёмки)
-- - processed_at IS NULL (нет даты обработки)
```

**Где считается:**
- Edge Function: `computeWeekAggregates()`, цикл по `factTasks` (строки 453-460)
- SQL: `recalculate_asana_stats_simple.sql`, строки 137-145

**SQL для расчета:**
```sql
SELECT COALESCE(SUM(q), 0)
INTO shot_not_processed
FROM asana_tasks
WHERE shot_at IS NOT NULL
  AND processed_at IS NULL
  AND completed != true
  AND week_shot = week_start_val
  AND q > 0;
```

**Код Edge Function:**
```typescript
// Функция computeWeekAggregates(), цикл по factTasks (строки 453-460)
// factTasks получаются из запроса:
// SELECT * FROM asana_tasks WHERE week_shot = weekStartStr OR week_processed = weekStartStr

for (const task of factTasks) {
  if (q > 0 && isShotThisWeek && !task.completed && !!task.shot_at && !task.processed_at) {
    shotNotProcessedQty += q;
  }
}
```

**Проблемы текущей логики:**
1. Показывает только то, что сфоткано на ЭТОЙ неделе
2. НЕ показывает накопительный долг (задачи, сфотканные раньше, но не обработанные)
3. Если задача сфоткана месяц назад, но не обработана, и дедлайн перенесен на месяц вперед — она НЕ попадает в этот показатель

**Использование на фронтенде:**
- `app.js`, функция `updateTasksCards()`, строка 2008: `shotNotProcessedValueEl.textContent = shotNotProcessedQty`
- Отображается в операционной карточке "Сфоткано, но не обработано"

---

## Предложения по изменению

### Предложение 1: Переименовать "Предстоит отснять" → "Обработать на этой неделе"

**Текущее название:** "Предстоит отснять"

**Предлагаемое название:** "Обработать на этой неделе"

**Обоснование:**
- Название "Предстоит отснять" не отражает реальную задачу — нужно обработать, а не отснять
- Фокус должен быть на обработке, так как съёмка уже может быть выполнена

**Изменение логики:**

**Текущая формула:**
```sql
-- Сумма q для задач, где:
-- - due_on в текущей неделе
-- - q > 0
-- - completed != true
```

**Предлагаемая формула:**
```sql
-- Сумма q для задач, где:
-- - due_on в текущей неделе
-- - processed_at IS NULL (не обработана)
-- - q > 0
-- - completed != true
```

**Ключевое изменение:** Добавлено условие `processed_at IS NULL` — показываем только то, что нужно обработать, а не все незавершенные задачи.

**SQL для расчета (предлагаемая):**
```sql
SELECT COALESCE(SUM(q), 0)
INTO to_process_this_week
FROM asana_tasks
WHERE due_on >= week_start_val 
  AND due_on <= week_end_val
  AND processed_at IS NULL
  AND q > 0
  AND completed != true;
```

**Код Edge Function (предлагаемая):**
```typescript
// В цикле по planTasks
if (!task.completed && !task.processed_at && q > 0) {
  toProcessThisWeekQty += q;
}
```

**Что это дает:**
- ✅ Показывает только то, что нужно обработать на этой неделе
- ✅ Исключает задачи, которые уже обработаны (даже если не закрыты)
- ✅ Более точное название отражает суть

---

### Предложение 2: Изменить "Сфоткано, но не обработано" на накопительный показатель

**Текущая логика:** Показывает только задачи, сфотканные на ЭТОЙ неделе

**Предлагаемая логика:** Показывает ВСЕ задачи, которые сфотканы, но не обработаны (накопительный долг)

**Обоснование:**
- Пользователь переносит дедлайны, если не успевает обработать
- Задачи, сфотканные давно, но не обработанные, должны показываться как накопительный долг
- Это помогает видеть реальный объем необработанной работы

**Изменение логики:**

**Текущая формула:**
```sql
-- Сумма q для задач, где:
-- - week_shot = weekStartStr (сфоткано на ЭТОЙ неделе)
-- - shot_at IS NOT NULL
-- - processed_at IS NULL
-- - completed != true
-- - q > 0
```

**Предлагаемая формула:**
```sql
-- Сумма q для задач, где:
-- - shot_at IS NOT NULL (сфоткана)
-- - processed_at IS NULL (не обработана)
-- - completed != true
-- - due_on НЕ в текущей неделе (или due_on IS NULL)
-- - q > 0
```

**Ключевое изменение:**
- Убрано условие `week_shot = weekStartStr` — показываем все сфотканные, но не обработанные задачи
- Добавлено условие `due_on НЕ в текущей неделе` — исключаем задачи, которые попадают в "Обработать на этой неделе"

**SQL для расчета (предлагаемая):**
```sql
SELECT COALESCE(SUM(q), 0)
INTO shot_not_processed_accumulated
FROM asana_tasks
WHERE shot_at IS NOT NULL
  AND processed_at IS NULL
  AND completed != true
  AND q > 0
  AND (
    due_on < week_start_val 
    OR due_on > week_end_val
    OR due_on IS NULL
  );
```

**Код Edge Function (предлагаемая):**
```typescript
// Запрос всех задач, где shot_at есть, но processed_at нет
const shotNotProcessedTasks = await supabase
  .from('asana_tasks')
  .select('*')
  .not('shot_at', 'is', null)
  .is('processed_at', null)
  .eq('completed', false)
  .gt('q', 0)
  .or(`due_on.lt.${weekStartStr},due_on.gt.${weekEndStr},due_on.is.null`);

let shotNotProcessedQty = 0;
for (const task of shotNotProcessedTasks) {
  shotNotProcessedQty += normalizeQ(task.q);
}
```

**Что это дает:**
- ✅ Показывает накопительный долг по обработке (не только текущей недели)
- ✅ Включает задачи, сфотканные давно, но не обработанные
- ✅ Помогает видеть реальный объем необработанной работы
- ✅ Четкое разделение: текущая неделя (по дедлайну) vs накопительный долг

---

## Связь между показателями

### Текущая связь

1. **"Уже на руках" + "Нужно взять со склада"** = сумма товаров из задач на эту неделю, которые предстоит выполнить (работа еще не начата)

2. **"Предстоит отснять"** = все незавершенные задачи с дедлайном в текущей неделе (может включать уже сфотканные, но не обработанные)

3. **"Сфоткано, но не обработано"** = задачи, сфотканные на ЭТОЙ неделе, но не обработанные

**Проблема:** "Предстоит отснять" и "Сфоткано, но не обработано" могут пересекаться (одна задача может попасть в оба показателя).

---

### Предлагаемая связь

1. **"Уже на руках" + "Нужно взять со склада"** = сумма товаров из задач на эту неделю, которые предстоит выполнить (работа еще не начата)
   - Без изменений

2. **"Обработать на этой неделе"** (было "Предстоит отснять") = задачи с дедлайном в текущей неделе, которые нужно обработать (`processed_at IS NULL`)
   - Показывает, что нужно сделать СЕЙЧАС (на этой неделе)

3. **"Сфоткано, но не обработано"** (накопительный) = все задачи, которые сфотканы, но не обработаны, и дедлайн НЕ в текущей неделе
   - Показывает накопительный долг (что накопилось за все время)

**Преимущество:** Нет дублирования — задача не может попасть в оба показателя одновременно (разделение по `due_on`).

---

## Процесс работы с товарами (как должно работать)

1. **Товар на руках или нужно взять со склада:**
   - Товар попадает в "Уже на руках" или "Нужно взять со склада"
   - Дедлайн в текущей неделе

2. **Товар сфотографирован:**
   - Товар уходит из "Уже на руках" (так как `shot_at` заполнено)
   - Если обработан сразу (`processed_at` заполнено в тот же день) → попадает в "Сделано"
   - Если не обработан (`processed_at IS NULL`) → попадает в "Обработать на этой неделе" (если дедлайн в текущей неделе)

3. **Если не успел обработать на этой неделе:**
   - Пользователь переносит дедлайн на будущее
   - Задача уходит из "Обработать на этой неделе" (так как `due_on` больше не в текущей неделе)
   - Задача попадает в "Сфоткано, но не обработано" (накопительный долг)

4. **Когда обработано:**
   - `processed_at` заполняется
   - Задача уходит из "Сфоткано, но не обработано"
   - Задача попадает в "Сделано" (если `completed = true`)

---

## Технические детали для реализации

### Изменения в Edge Function

**Файл:** `supabase/functions/fetch-asana-stats/index.ts`

**1. Изменение расчета "Обработать на этой неделе" (было `to_shoot_qty`):**

**Было:**
```typescript
// В цикле по planTasks (строки 473-499)
if (!task.completed && q > 0) {
  toShootQty += q;
}
```

**Должно быть:**
```typescript
// В цикле по planTasks
if (!task.completed && !task.processed_at && q > 0) {
  toProcessThisWeekQty += q; // Переименовать переменную
}
```

**2. Изменение расчета "Сфоткано, но не обработано" (накопительный):**

**Было:**
```typescript
// В цикле по factTasks (строки 453-460)
if (q > 0 && isShotThisWeek && !task.completed && !!task.shot_at && !task.processed_at) {
  shotNotProcessedQty += q;
}
```

**Должно быть:**
```typescript
// Отдельный запрос для накопительного показателя
const shotNotProcessedTasks = await supabase
  .from('asana_tasks')
  .select('*')
  .not('shot_at', 'is', null)
  .is('processed_at', null)
  .eq('completed', false)
  .gt('q', 0)
  .or(`due_on.lt.${weekStartStr},due_on.gt.${weekEndStr},due_on.is.null`);

let shotNotProcessedQty = 0;
for (const task of shotNotProcessedTasks.data || []) {
  const q = normalizeQ(task.q);
  if (q > 0) {
    shotNotProcessedQty += q;
  }
}
```

**3. Обновление возвращаемых полей:**

```typescript
return {
  success: true,
  data: {
    // ... другие поля
    to_process_this_week: toProcessThisWeekQty, // Было: to_shoot_qty
    shot_not_processed_qty: shotNotProcessedQty, // Накопительный показатель
    // ... другие поля
  }
};
```

---

### Изменения в SQL (для пересчета статистики)

**Файл:** `recalculate_asana_stats_simple.sql`

**1. Изменение расчета "Обработать на этой неделе":**

**Было:**
```sql
-- 2. to_shoot_qty: сумма q для задач, где due_on в текущей неделе, q > 0, completed != true
SELECT COALESCE(SUM(q), 0)
INTO to_shoot
FROM asana_tasks
WHERE due_on >= week_start_val 
  AND due_on <= week_end_val
  AND q > 0
  AND completed != true;
```

**Должно быть:**
```sql
-- 2. to_process_this_week: сумма q для задач, где due_on в текущей неделе, processed_at IS NULL, q > 0, completed != true
SELECT COALESCE(SUM(q), 0)
INTO to_process_this_week
FROM asana_tasks
WHERE due_on >= week_start_val 
  AND due_on <= week_end_val
  AND processed_at IS NULL
  AND q > 0
  AND completed != true;
```

**2. Изменение расчета "Сфоткано, но не обработано" (накопительный):**

**Было:**
```sql
-- 8. shot_not_processed_qty: сумма q для задач, где shot_at заполнено, processed_at IS NULL, completed != true, week_shot = текущая неделя
SELECT COALESCE(SUM(q), 0)
INTO shot_not_processed
FROM asana_tasks
WHERE shot_at IS NOT NULL
  AND processed_at IS NULL
  AND completed != true
  AND week_shot = week_start_val
  AND q > 0;
```

**Должно быть:**
```sql
-- 8. shot_not_processed_qty: сумма q для задач, где shot_at заполнено, processed_at IS NULL, completed != true, due_on НЕ в текущей неделе (накопительный)
SELECT COALESCE(SUM(q), 0)
INTO shot_not_processed
FROM asana_tasks
WHERE shot_at IS NOT NULL
  AND processed_at IS NULL
  AND completed != true
  AND q > 0
  AND (
    due_on < week_start_val 
    OR due_on > week_end_val
    OR due_on IS NULL
  );
```

**3. Обновление INSERT/UPDATE в asana_stats:**

```sql
INSERT INTO asana_stats (
  week_start_date,
  week_end_date,
  done_fact_this_week,
  to_process_this_week, -- Было: to_shoot_qty
  week_load,
  plan,
  done_qty,
  carry_over_from_prev,
  on_hand_qty,
  warehouse_qty,
  shot_not_processed_qty, -- Накопительный показатель
  q_errors_count,
  done_stm_qty,
  done_nonstm_qty,
  remaining_to_plan,
  overtime_qty,
  updated_at
)
VALUES (
  week_start_val,
  week_end_val,
  done_fact,
  to_process_this_week, -- Было: to_shoot
  week_load_val,
  plan_val,
  done_qty_val,
  carry_over_val,
  on_hand,
  warehouse,
  shot_not_processed, -- Накопительный показатель
  q_errors,
  done_stm,
  done_nonstm,
  remaining_to_plan,
  overtime_qty_val,
  NOW()
)
ON CONFLICT (week_start_date) DO UPDATE SET
  -- ... обновление полей
  to_process_this_week = EXCLUDED.to_process_this_week, -- Было: to_shoot_qty
  shot_not_processed_qty = EXCLUDED.shot_not_processed_qty, -- Накопительный показатель
  -- ... другие поля
```

---

### Изменения на фронтенде

**Файл:** `app.js`

**1. Обновление нормализации данных:**

**Было:**
```javascript
toShootQty: data.to_shoot_qty ?? 0,
```

**Должно быть:**
```javascript
toProcessThisWeek: data.to_process_this_week ?? data.to_shoot_qty ?? 0, // Fallback на старое поле для совместимости
```

**2. Обновление отображения:**

**Было:**
```javascript
<h3 class="kpi-title">Предстоит отснять</h3>
<div id="pendingCount" class="kpi-value kpi-value--pending">${toShootQty}</div>
```

**Должно быть:**
```javascript
<h3 class="kpi-title">Обработать на этой неделе</h3>
<div id="pendingCount" class="kpi-value kpi-value--pending">${toProcessThisWeek}</div>
```

**3. Обновление функции `updateTasksCards()`:**

**Было:**
```javascript
const toShootQty = stats.toShootQty ?? stats.to_shoot_qty ?? 0;
if (pendingValue) pendingValue.textContent = toShootQty;
```

**Должно быть:**
```javascript
const toProcessThisWeek = stats.toProcessThisWeek ?? stats.to_process_this_week ?? stats.toShootQty ?? stats.to_shoot_qty ?? 0;
if (pendingValue) pendingValue.textContent = toProcessThisWeek;
```

**4. Обновление расчета `week_load`:**

**Было:**
```javascript
const weekLoad = stats.weekLoad ?? stats.week_load ?? doneFact + toShootQty;
```

**Должно быть:**
```javascript
const weekLoad = stats.weekLoad ?? stats.week_load ?? doneFact + toProcessThisWeek;
```

---

### Изменения в схеме базы данных

**Файл:** `migrate_asana_stats_schema.sql` (если нужно добавить новое поле)

**Вариант 1: Переименовать поле (рекомендуется для чистоты)**

```sql
-- Миграция: переименовать to_shoot_qty в to_process_this_week
ALTER TABLE asana_stats 
  RENAME COLUMN to_shoot_qty TO to_process_this_week;

-- Обновить комментарии
COMMENT ON COLUMN asana_stats.to_process_this_week IS 'Объем задач с дедлайном в текущей неделе, которые нужно обработать (processed_at IS NULL)';
```

**Вариант 2: Добавить новое поле (для обратной совместимости)**

```sql
-- Добавить новое поле
ALTER TABLE asana_stats 
  ADD COLUMN IF NOT EXISTS to_process_this_week INTEGER DEFAULT 0;

-- Заполнить новое поле из старого (для существующих записей)
UPDATE asana_stats 
SET to_process_this_week = to_shoot_qty 
WHERE to_process_this_week = 0;

-- Позже можно удалить старое поле (после проверки)
-- ALTER TABLE asana_stats DROP COLUMN to_shoot_qty;
```

**Для `shot_not_processed_qty`:** Изменение логики не требует изменения схемы, только изменение SQL-запроса.

---

## Итоговая таблица изменений

| Показатель | Текущее название | Предлагаемое название | Изменение логики |
|------------|------------------|----------------------|------------------|
| `to_shoot_qty` | "Предстоит отснять" | "Обработать на этой неделе" | Добавить условие `processed_at IS NULL` |
| `shot_not_processed_qty` | "Сфоткано, но не обработано" | "Сфоткано, но не обработано" (без изменений) | Убрать условие `week_shot = текущая неделя`, добавить условие `due_on НЕ в текущей неделе` |
| `on_hand_qty` | "Уже на руках" | Без изменений | Без изменений |
| `warehouse_qty` | "Нужно взять со склада" | Без изменений | Без изменений |
| `done_qty` | "Сделано" | Без изменений | Без изменений |
| `plan` | "План недели" | Без изменений | Без изменений |
| `remaining_to_plan` | "До выполнения плана" | Без изменений | Без изменений |

---

## Резюме

### Текущие проблемы

1. **"Предстоит отснять"** не отражает реальную задачу (нужно обработать, а не отснять)
2. **"Сфоткано, но не обработано"** показывает только текущую неделю, не показывает накопительный долг
3. Задачи могут попадать в оба показателя одновременно (дублирование)
4. Не видно реального объема необработанной работы (задачи, сфотканные давно, но не обработанные)

### Предлагаемые решения

1. **Переименовать и изменить логику "Предстоит отснять"** → "Обработать на этой неделе"
   - Добавить условие `processed_at IS NULL`
   - Показывать только то, что нужно обработать на этой неделе

2. **Изменить логику "Сфоткано, но не обработано"** на накопительный показатель
   - Убрать условие `week_shot = текущая неделя`
   - Добавить условие `due_on НЕ в текущей неделе`
   - Показывать весь накопительный долг по обработке

### Преимущества

1. ✅ Нет дублирования — задачи не могут попасть в оба показателя одновременно
2. ✅ Более точные названия отражают суть
3. ✅ Виден накопительный долг по обработке
4. ✅ Четкое разделение: текущая неделя vs накопительный долг
5. ✅ Соответствует реальному процессу работы пользователя

---

## Дополнительные файлы для справки

- `docs/tasks-backend-current.md` — текущая бэкенд-логика
- `docs/tasks-tab-overview.md` — обзор вкладки "Задачи"
- `recalculate_asana_stats_simple.sql` — SQL для пересчета статистики
- `app.js` — фронтенд-код (функции `getAsanaStats()`, `updateTasksCards()`, `renderTasks()`)
- `supabase/functions/fetch-asana-stats/index.ts` — Edge Function (вне репозитория)

---

**Версия документа:** 1.0  
**Дата создания:** 2025-12-10  
**Автор:** Анализ на основе требований пользователя

