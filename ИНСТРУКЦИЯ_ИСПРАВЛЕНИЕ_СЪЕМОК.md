# Инструкция для AI ассистента: Исправление проблемы с отображением съёмок на сайте

## Проблема
Данные из Supabase (таблица `shootings`) не отображаются на сайте TimeTracker в экране начальника.

## Быстрое решение

**Скажи AI ассистенту:**

"Проверь и исправь проблему с отображением съёмок на сайте. Данные из Supabase не попадают на сайт. Следуй инструкции из файла ИНСТРУКЦИЯ_ИСПРАВЛЕНИЕ_СЪЕМОК.md. Начни с проверки подключения библиотеки Supabase в HTML файлах, затем проверь инициализацию клиента в app.js, добавь отладочное логирование в функции getUpcomingShootings() и renderShootings(), и проверь права доступа в Supabase."

## Что нужно проверить и исправить

### Шаг 1: Проверить подключение библиотеки Supabase

**Файлы для проверки:**
- `/Users/stanislav/web/boss.html`
- `/Users/stanislav/web/index.html`

**Что проверить:**
1. В `<head>` должен быть подключен скрипт Supabase:
   ```html
   <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
   ```
   ИЛИ
   ```html
   <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
   ```

2. Скрипт должен быть подключен **ДО** подключения `app.js`:
   ```html
   <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
   <script src="app.js"></script>
   ```

**Если скрипт не подключен:**
- Добавьте его в `<head>` перед `app.js`

### Шаг 2: Проверить инициализацию Supabase клиента

**Файл:** `/Users/stanislav/web/app.js`

**Что проверить:**
1. В начале файла должны быть правильные константы:
   ```javascript
   const SUPABASE_URL = 'https://uqgpynqnboyeqvsaljso.supabase.co';
   const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxZ3B5bnFuYm95ZXF2c2FsanNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMDc0NjIsImV4cCI6MjA3NzY4MzQ2Mn0.lpzVJN2yL5xeKHcBYhUkxP9ZyvvQ2LJY4Ng7yJzLlG8';
   ```

2. Функция `initSupabase()` должна правильно инициализировать клиент:
   ```javascript
   function initSupabase() {
     const supabaseLib = window.supabase || (typeof supabase !== 'undefined' ? supabase : null);
     
     if (supabaseLib && SUPABASE_URL && SUPABASE_ANON_KEY) {
       try {
         supabaseClient = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
         console.log('Supabase инициализирован');
       } catch (e) {
         console.error('Ошибка инициализации Supabase:', e);
       }
     } else {
       console.error('Библиотека Supabase не загружена или не настроены ключи');
     }
   }
   ```

3. Функция `waitForSupabase()` должна правильно ждать загрузки библиотеки

**Если есть проблемы:**
- Убедитесь, что библиотека загружается до инициализации
- Добавьте больше логирования для отладки
- Проверьте, что `window.supabase` доступен

### Шаг 3: Проверить функцию getUpcomingShootings()

**Файл:** `/Users/stanislav/web/app.js` (около строки 290)

**Что проверить:**
1. Функция должна проверять инициализацию клиента:
   ```javascript
   async function getUpcomingShootings() {
     try {
       if (!supabaseClient) {
         console.error('Supabase не инициализирован');
         return [];
       }
       
       const today = todayISO();
       
       const { data, error } = await supabaseClient
         .from('shootings')
         .select('*')
         .gte('date', today)
         .order('date', { ascending: true })
         .order('start_time', { ascending: true });
       
       if (error) {
         console.error('Ошибка загрузки съёмок:', error);
         return [];
       }
       
       console.log('Загружено съёмок:', data?.length || 0); // Добавить логирование
       return data || [];
     } catch (e) {
       console.error('Ошибка загрузки съёмок:', e);
       return [];
     }
   }
   ```

2. Добавить логирование для отладки:
   - Логировать количество загруженных съёмок
   - Логировать ошибки с подробностями

**Если есть проблемы:**
- Проверить, что таблица `shootings` существует в Supabase
- Проверить права доступа (anon key должен иметь доступ на SELECT)
- Добавить больше логирования

### Шаг 4: Проверить функцию renderShootings()

**Файл:** `/Users/stanislav/web/app.js` (около строки 1640)

**Что проверить:**
1. Функция должна правильно вызывать `getUpcomingShootings()`:
   ```javascript
   async function renderShootings() {
     const shootingsList = $('#shootingsList');
     if (!shootingsList) {
       console.error('Элемент shootingsList не найден');
       return;
     }
     
     try {
       console.log('Начинаем загрузку съёмок...'); // Добавить логирование
       const shootings = await getUpcomingShootings();
       console.log('Получено съёмок:', shootings.length); // Добавить логирование
       
       if (shootings.length === 0) {
         shootingsList.innerHTML = `
           <div class="day-header">Предстоящие съёмки</div>
           <div class="day-content muted">Нет предстоящих съёмок</div>
         `;
         return;
       }
       
       // ... остальной код
     } catch (error) {
       console.error('Ошибка загрузки съёмок:', error);
       shootingsList.innerHTML = `
         <div class="day-header">Предстоящие съёмки</div>
         <div class="day-content muted">Ошибка загрузки съёмок: ${error.message}</div>
       `;
     }
   }
   ```

2. Добавить логирование для отладки

**Если есть проблемы:**
- Проверить, что элемент `#shootingsList` существует в DOM
- Добавить обработку ошибок с отображением сообщения

### Шаг 5: Проверить права доступа в Supabase

**Что проверить в Supabase Dashboard:**

1. Откройте [Supabase Dashboard](https://supabase.com/dashboard/project/uqgpynqnboyeqvsaljso)
2. Перейдите в **Authentication** → **Policies**
3. Выберите таблицу `shootings`
4. Убедитесь, что есть политика для **anon** пользователей на **SELECT**:
   ```sql
   -- Политика должна разрешать SELECT для всех (или для аутентифицированных)
   CREATE POLICY "Allow public read access" ON shootings
   FOR SELECT
   USING (true);
   ```

**Если политики нет:**
- Создайте политику, которая разрешает SELECT для anon пользователей
- Или используйте политику для authenticated пользователей (если нужна авторизация)

### Шаг 6: Проверить данные в Supabase

**Что проверить:**

1. Откройте Supabase Dashboard → **Table Editor**
2. Выберите таблицу `shootings`
3. Убедитесь, что:
   - В таблице есть записи
   - Записи имеют правильный формат:
     - `date` - формат DATE (YYYY-MM-DD)
     - `start_time` - формат TIME (HH:MM:SS)
     - `end_time` - формат TIME (HH:MM:SS)
     - `google_event_id` - TEXT (уникальный)
   - Есть записи с датами >= сегодняшней даты

### Шаг 7: Добавить отладочное логирование

**Файл:** `/Users/stanislav/web/app.js`

**Что добавить:**

1. В функцию `initSupabase()`:
   ```javascript
   function initSupabase() {
     console.log('Инициализация Supabase...');
     console.log('SUPABASE_URL:', SUPABASE_URL);
     console.log('SUPABASE_ANON_KEY:', SUPABASE_ANON_KEY ? 'установлен' : 'не установлен');
     
     const supabaseLib = window.supabase || (typeof supabase !== 'undefined' ? supabase : null);
     console.log('Библиотека Supabase:', supabaseLib ? 'найдена' : 'не найдена');
     
     if (supabaseLib && SUPABASE_URL && SUPABASE_ANON_KEY) {
       try {
         supabaseClient = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
         console.log('✓ Supabase клиент создан успешно');
       } catch (e) {
         console.error('✗ Ошибка создания Supabase клиента:', e);
       }
     } else {
       console.error('✗ Не удалось инициализировать Supabase');
     }
   }
   ```

2. В функцию `getUpcomingShootings()`:
   ```javascript
   async function getUpcomingShootings() {
     console.log('getUpcomingShootings() вызвана');
     console.log('supabaseClient:', supabaseClient ? 'инициализирован' : 'не инициализирован');
     
     try {
       if (!supabaseClient) {
         console.error('✗ Supabase не инициализирован');
         return [];
       }
       
       const today = todayISO();
       console.log('Сегодняшняя дата:', today);
       
       console.log('Отправляем запрос к Supabase...');
       const { data, error } = await supabaseClient
         .from('shootings')
         .select('*')
         .gte('date', today)
         .order('date', { ascending: true })
         .order('start_time', { ascending: true });
       
       if (error) {
         console.error('✗ Ошибка загрузки съёмок:', error);
         console.error('Детали ошибки:', JSON.stringify(error, null, 2));
         return [];
       }
       
       console.log('✓ Загружено съёмок:', data?.length || 0);
       if (data && data.length > 0) {
         console.log('Первая съёмка:', data[0]);
       }
       return data || [];
     } catch (e) {
       console.error('✗ Исключение при загрузке съёмок:', e);
       return [];
     }
   }
   ```

3. В функцию `renderShootings()`:
   ```javascript
   async function renderShootings() {
     console.log('renderShootings() вызвана');
     const shootingsList = $('#shootingsList');
     if (!shootingsList) {
       console.error('✗ Элемент #shootingsList не найден');
       return;
     }
     
     try {
       console.log('Загружаем съёмки...');
       const shootings = await getUpcomingShootings();
       console.log('Получено съёмок для отображения:', shootings.length);
       
       // ... остальной код
     } catch (error) {
       console.error('✗ Ошибка в renderShootings():', error);
       // ... обработка ошибки
     }
   }
   ```

### Шаг 8: Проверить консоль браузера

**Что проверить:**

1. Откройте сайт в браузере
2. Откройте консоль разработчика (F12 или Cmd+Option+I)
3. Перейдите на экран начальника
4. Нажмите "Показать съёмки"
5. Проверьте логи в консоли:
   - Должны быть сообщения об инициализации Supabase
   - Должны быть сообщения о загрузке съёмок
   - Если есть ошибки - скопируйте их

**Возможные ошибки:**
- `Supabase не инициализирован` - библиотека не загружена
- `Ошибка загрузки съёмок: ...` - проблема с запросом к Supabase
- `Элемент #shootingsList не найден` - проблема с DOM

### Шаг 9: Проверить структуру таблицы shootings

**Что проверить в Supabase:**

1. Откройте Supabase Dashboard → **Table Editor** → `shootings`
2. Убедитесь, что структура таблицы соответствует:
   ```sql
   CREATE TABLE shootings (
     id UUID PRIMARY KEY,
     date DATE NOT NULL,
     start_time TIME NOT NULL,
     end_time TIME NOT NULL,
     google_event_id TEXT UNIQUE,
     created_at TIMESTAMP,
     updated_at TIMESTAMP
   );
   ```

3. Проверьте, что есть индекс на `date`:
   ```sql
   CREATE INDEX IF NOT EXISTS idx_shootings_date ON shootings(date);
   ```

### Шаг 10: Финальная проверка

**Что проверить:**

1. ✅ Библиотека Supabase подключена в HTML
2. ✅ Ключи SUPABASE_URL и SUPABASE_ANON_KEY установлены
3. ✅ Supabase клиент инициализируется без ошибок
4. ✅ Функция getUpcomingShootings() возвращает данные
5. ✅ Функция renderShootings() отображает данные
6. ✅ В Supabase есть политики доступа для anon пользователей
7. ✅ В таблице shootings есть данные с датами >= сегодня
8. ✅ В консоли браузера нет ошибок

## Если проблема не решена

1. Скопируйте все ошибки из консоли браузера
2. Проверьте Network tab в DevTools - есть ли запросы к Supabase?
3. Проверьте ответы от Supabase API - что возвращает сервер?
4. Убедитесь, что данные в Supabase имеют правильный формат дат

## Дополнительные проверки

### Проверка формата дат

Убедитесь, что в Supabase даты хранятся в формате `YYYY-MM-DD`:
- ✅ Правильно: `2025-11-10`
- ❌ Неправильно: `10.11.2025` или `10/11/2025`

### Проверка времени

Убедитесь, что время хранится в формате `HH:MM:SS`:
- ✅ Правильно: `13:20:00`
- ❌ Неправильно: `1:20 PM` или `13:20`

### Проверка фильтрации

Функция `getUpcomingShootings()` фильтрует записи по условию `gte('date', today)`.
Убедитесь, что:
- В таблице есть записи с датами >= сегодня
- Формат даты в таблице соответствует формату `todayISO()` (YYYY-MM-DD)

